---
import Base from '../../../layouts/Base.astro';
import { getRestaurant, getMenu, getOrders, getDailyStats } from '../../../lib/kv.js';
import { requireAuth } from '../../../lib/auth.js';

const { slug } = Astro.params;
const kv = Astro.locals.runtime.env.MENULINX_KV;
const kvSessions = Astro.locals.runtime.env.MENULINX_SESSIONS;

const session = await requireAuth(Astro.request, kvSessions);
if (!session || session.slug !== slug) return Astro.redirect(`/${slug}/admin/login`);

const restaurant = await getRestaurant(kv, slug);
if (!restaurant) return Astro.redirect('/404');

const menu = await getMenu(kv, slug);
const orders = await getOrders(kv, slug);
const stats = await getDailyStats(kv, slug);
const cur = restaurant.currency || '£';
---
<Base title={`Dashboard | ${restaurant.name}`} themeColor="#0057B8">

<style>
  .admin-header { background: linear-gradient(135deg, #0057B8, #00C8E8); color: white; padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; }
  .admin-header h1 { font-size: 1.5rem; } .admin-header p { opacity: 0.9; font-size: 0.9rem; }
  .logout-btn { background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; border: 1px solid rgba(255,255,255,0.3); }
  .container { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }

  /* Tabs */
  .tabs { display: flex; gap: 0.5rem; border-bottom: 2px solid #f0f0f0; overflow-x: auto; margin-bottom: 2rem; }
  .tab { padding: 0.9rem 1.2rem; background: none; border: none; border-bottom: 3px solid transparent; font-weight: 600; color: #888; white-space: nowrap; }
  .tab.active { color: #0057B8; border-bottom-color: #0057B8; }
  .panel { display: none; } .panel.active { display: block; }

  /* Stats cards */
  .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .stat-card { background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .stat-card .label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-card .value { font-size: 1.8rem; font-weight: 800; color: #0057B8; }

  /* Orders */
  .order-card { background: white; border-radius: 12px; padding: 1.25rem; margin-bottom: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid #ccc; }
  .order-card.status-new { border-left-color: #FFC107; } .order-card.status-accepted { border-left-color: #0057B8; } .order-card.status-ready { border-left-color: #28A745; }
  .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
  .badge { padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
  .badge-new { background: #FFF3CD; color: #856404; } .badge-accepted { background: #D1ECF1; color: #0C5460; } .badge-ready { background: #D4EDDA; color: #155724; }
  .order-items { font-size: 0.9rem; color: var(--grey); margin: 0.5rem 0; }
  .order-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
  .act-btn { padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; font-size: 0.85rem; color: white; }
  .act-accept { background: #0057B8; } .act-ready { background: #28A745; } .act-deliver { background: #6f42c1; } .act-reject { background: #DC3545; }

  /* Menu items */
  .menu-item { background: white; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 0.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
  .menu-item .name { font-weight: 600; } .menu-item .cat { font-size: 0.8rem; color: #888; }
  .menu-item .price { font-weight: 700; color: #0057B8; }
  .del-btn { background: #fde8e8; color: var(--danger); padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600; font-size: 0.8rem; }
  .add-form { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 1.5rem; }
  .form-row { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 0.75rem; align-items: end; }
  .form-row input, .form-row select { padding: 0.6rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; }
  .add-btn { padding: 0.6rem 1.2rem; background: #0057B8; color: white; border-radius: 8px; font-weight: 600; }

  /* Import */
  .upload-zone { border: 3px dashed #ccc; border-radius: 16px; padding: 3rem 2rem; text-align: center; background: white; cursor: pointer; margin-bottom: 1.5rem; }
  .upload-zone:hover { border-color: #0057B8; background: #f8faff; }
  .upload-zone p { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.3rem; }
  .upload-zone small { color: #888; }
  .progress-bar { height: 6px; background: #e0e0e0; border-radius: 3px; margin: 1rem 0; overflow: hidden; display: none; }
  .progress-bar .fill { height: 100%; background: #0057B8; width: 0%; transition: width 0.3s; }
  .extracted-wrap { display: none; } .extracted-wrap.show { display: block; }
  .ext-item { background: white; border-radius: 10px; padding: 1rem; margin-bottom: 0.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 0.5rem; align-items: center; }
  .ext-item input { padding: 0.5rem; border: 1.5px solid #e0e0e0; border-radius: 6px; }
  .ext-remove { background: #fde8e8; color: var(--danger); padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
  .save-banner { display: none; position: sticky; bottom: 1rem; background: #0057B8; color: white; padding: 1rem 2rem; border-radius: 12px; text-align: center; font-weight: 700; font-size: 1.05rem; }
  .save-banner.show { display: block; cursor: pointer; }

  /* Settings */
  .settings-card { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .settings-card .field { margin-bottom: 1.25rem; }
  .settings-card label { display: block; font-weight: 600; margin-bottom: 0.3rem; font-size: 0.9rem; }
  .settings-card input, .settings-card select { width: 100%; padding: 0.7rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; }
  .settings-card .check-group label { font-weight: 500; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
  .save-settings { padding: 0.9rem 2rem; background: #0057B8; color: white; border-radius: 10px; font-weight: 700; font-size: 1rem; }

  .empty-state { text-align: center; padding: 3rem; color: #888; font-size: 1.1rem; }
</style>

<!-- HEADER -->
<div class="admin-header">
  <div>
    <h1>{restaurant.name}</h1>
    <p>Admin Dashboard</p>
  </div>
  <button class="logout-btn" id="logoutBtn">Logout</button>
</div>

<div class="container">

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" data-tab="dashboard">Dashboard</button>
    <button class="tab" data-tab="orders">Orders ({orders.length})</button>
    <button class="tab" data-tab="menu">Menu ({menu.length})</button>
    <button class="tab" data-tab="import">Import</button>
    <button class="tab" data-tab="settings">Settings</button>
  </div>

  <!-- DASHBOARD PANEL -->
  <div class="panel active" id="panel-dashboard">
    <div class="stats-row">
      <div class="stat-card"><div class="label">Orders Today</div><div class="value">{stats.orders}</div></div>
      <div class="stat-card"><div class="label">Revenue Today</div><div class="value">{cur}{stats.revenue.toFixed(2)}</div></div>
      <div class="stat-card"><div class="label">Active Orders</div><div class="value">{orders.filter(o => o.status !== 'delivered').length}</div></div>
      <div class="stat-card"><div class="label">Menu Items</div><div class="value">{menu.length}</div></div>
    </div>
    {orders.length === 0
      ? <p class="empty-state">No orders yet. Share your menu link to get started!</p>
      : <p style="color:#888; font-size:0.9rem;">Switch to the Orders tab to manage active orders.</p>
    }
    <p style="margin-top:1rem; font-size:0.9rem; color:#888;">Customer menu: <a href={`/${slug}`} style="color:#0057B8; font-weight:600;">/{slug}</a></p>
  </div>

  <!-- ORDERS PANEL -->
  <div class="panel" id="panel-orders">
    <div id="ordersContainer">
      {orders.length === 0
        ? <p class="empty-state">No active orders</p>
        : orders.map(o => {
            const sc = o.status === 'new' ? 'status-new' : o.status === 'accepted' ? 'status-accepted' : o.status === 'ready' ? 'status-ready' : '';
            const bc = o.status === 'new' ? 'badge-new' : o.status === 'accepted' ? 'badge-accepted' : 'badge-ready';
            const bl = o.status === 'new' ? 'New' : o.status === 'accepted' ? 'Preparing' : o.status === 'ready' ? 'Ready' : o.status;
            return (
              <div class={`order-card ${sc}`} data-order-id={o.id}>
                <div class="order-header">
                  <strong>{o.customerName} — #{o.id.slice(-4)}</strong>
                  <span class={`badge ${bc}`}>{bl}</span>
                </div>
                <div class="order-items">{o.items.map(i => `${i.qty}x ${i.name}`).join(', ')}</div>
                <div style="font-weight:700;">{cur}{o.total.toFixed(2)} — {o.orderType}</div>
                {o.notes && <div style="font-size:0.85rem; color:#888; margin-top:0.3rem;">Note: {o.notes}</div>}
                <div class="order-actions">
                  {o.status === 'new' && <><button class="act-btn act-accept" data-action="accepted" data-oid={o.id}>Accept</button><button class="act-btn act-reject" data-action="rejected" data-oid={o.id}>Reject</button></>}
                  {o.status === 'accepted' && <button class="act-btn act-ready" data-action="ready" data-oid={o.id}>Mark Ready</button>}
                  {o.status === 'ready' && <button class="act-btn act-deliver" data-action="delivered" data-oid={o.id}>Delivered</button>}
                </div>
              </div>
            );
          })
      }
    </div>
  </div>

  <!-- MENU PANEL -->
  <div class="panel" id="panel-menu">
    <div class="add-form">
      <h3 style="margin-bottom:1rem;">Add Menu Item</h3>
      <div class="form-row">
        <input id="newName" placeholder="Item name" />
        <input id="newPrice" type="number" step="0.01" placeholder="Price" />
        <input id="newCat" placeholder="Category" value="Main" />
        <button class="add-btn" id="addItemBtn">Add</button>
      </div>
    </div>
    <div id="menuList">
      {menu.length === 0
        ? <p class="empty-state">No menu items yet. Add some above or use the Import tab.</p>
        : menu.map(item => (
            <div class="menu-item" data-mid={item.id}>
              <div><span class="name">{item.name}</span><br/><span class="cat">{item.category}</span></div>
              <span class="price">{cur}{item.price.toFixed(2)}</span>
              <button class="del-btn" data-mid={item.id}>Delete</button>
            </div>
          ))
      }
    </div>
  </div>

  <!-- IMPORT PANEL (OCR) -->
  <div class="panel" id="panel-import">
    <div class="upload-zone" id="uploadZone">
      <p>Upload a menu photo</p>
      <small>Tap or drag an image — JPG, PNG supported</small>
      <input type="file" id="menuFile" accept="image/*" style="display:none" />
    </div>
    <div class="progress-bar" id="ocrProgress"><div class="fill" id="ocrFill"></div></div>
    <p id="ocrStatus" style="text-align:center; color:#888; margin-bottom:1rem;"></p>
    <div class="extracted-wrap" id="extractedWrap">
      <h3 style="margin-bottom:1rem;">Extracted Items — Review & Edit</h3>
      <div id="extractedList"></div>
    </div>
    <div class="save-banner" id="saveBanner">Save to Live Menu</div>
  </div>

  <!-- SETTINGS PANEL -->
  <div class="panel" id="panel-settings">
    <div class="settings-card">
      <form id="settingsForm">
        <div class="field">
          <label>Restaurant Name</label>
          <input name="name" value={restaurant.name} />
        </div>
        <div class="field">
          <label>Tagline</label>
          <input name="tagline" value={restaurant.tagline || ''} />
        </div>
        <div class="field">
          <label>Currency</label>
          <select name="currency">
            <option value="£" selected={cur === '£'}>£ GBP</option>
            <option value="€" selected={cur === '€'}>€ EUR</option>
            <option value="$" selected={cur === '$'}>$ USD</option>
          </select>
        </div>
        <div class="field">
          <label>Delivery Fee</label>
          <input name="deliveryFee" type="number" step="0.01" value={restaurant.deliveryFee || 0} />
        </div>
        <div class="field">
          <label>Minimum Order</label>
          <input name="minOrder" type="number" step="0.01" value={restaurant.minOrder || 0} />
        </div>
        <h3 style="margin:1.5rem 0 0.75rem;">SMS Notifications (Connect98)</h3>
        <div class="field">
          <label>API Key</label>
          <input name="smsApiKey" type="password" value={restaurant.sms?.apiKey || ''} placeholder="Your Connect98 API key" />
        </div>
        <div class="check-group">
          <label><input type="checkbox" name="smsEnabled" checked={restaurant.sms?.enabled} /> Enable SMS notifications</label>
          <label><input type="checkbox" name="smsReceived" checked={restaurant.sms?.events?.orderReceived !== false} /> Order received</label>
          <label><input type="checkbox" name="smsAccepted" checked={restaurant.sms?.events?.orderAccepted !== false} /> Order accepted</label>
          <label><input type="checkbox" name="smsReady" checked={restaurant.sms?.events?.orderReady !== false} /> Order ready</label>
          <label><input type="checkbox" name="smsDelivered" checked={restaurant.sms?.events?.orderDelivered !== false} /> Order delivered</label>
        </div>
        <button type="submit" class="save-settings">Save Settings</button>
      </form>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script define:vars={{ slug, ordersJson: JSON.stringify(orders), currency: cur }}>
  window.__MLX__ = { slug, orders: JSON.parse(ordersJson), currency };
</script>
<script src="/js/admin.js"></script>

</Base>
